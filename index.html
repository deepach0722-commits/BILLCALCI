<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smart Energy Bill Calculator (Offline, Multilang)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{ --accent:#0b6efd; --accent2:#00b4d8; --muted:#6b7280; --card:#ffffffcc; }
  body{ font-family:"Poppins",sans-serif; margin:0; background:linear-gradient(135deg,#e6fffa,#f0f9ff); color:#0b2545; }
  header{ background:linear-gradient(90deg,var(--accent),var(--accent2)); color:white; padding:20px; text-align:center; box-shadow:0 6px 20px rgba(3,10,27,0.12); }
  header h1{ margin:0; font-size:22px; }
  .container{ max-width:1100px; margin:18px auto; padding:18px; background:var(--card); border-radius:14px; box-shadow:0 6px 30px rgba(2,6,23,0.06); }
  .topbar{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
  label{ font-weight:600; font-size:14px; }
  select,input,button{ padding:8px 10px; border-radius:8px; border:1px solid #d1e7ff; font-size:14px; }
  .controls{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
  button.primary{ background:var(--accent); color:white; border:none; cursor:pointer; }
  button.danger{ background:#ff6b6b; color:white; border:none; cursor:pointer; }
  .devices{ margin-top:12px; }
  .device-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:8px; border-radius:8px; background:#f7fdff; border:1px solid #e6f6ff; }
  .device-row img.icon{ width:36px; height:36px; object-fit:contain; border-radius:6px; }
  .device-row select, .device-row input { min-width:150px; }
  .remove-btn{ background:#ffb3b3; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; }
  .cards{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px; }
  .card{ background:white; padding:14px; border-radius:12px; box-shadow:0 4px 14px rgba(2,6,23,0.06); }
  .card h3{ margin:0 0 8px 0; color:var(--accent); }
  .appliance-row{ display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #eef6ff; }
  .small{ font-size:13px; color:var(--muted); }
  .awareness{ margin-top:14px; display:flex; gap:12px; background:#f0fff4; padding:12px; border-radius:10px; align-items:center; }
  .awareness img{ width:72px; height:72px; }
  .tips{ margin-top:12px; }
  /* AI chat */
  .ai-chat{ position:fixed; bottom:18px; right:18px; width:340px; max-width:96%; background:white; border-radius:12px; box-shadow:0 8px 40px rgba(2,6,23,0.18); overflow:hidden; display:flex; flex-direction:column; }
  .ai-header{ background:var(--accent); color:white; padding:10px; display:flex; justify-content:space-between; align-items:center; font-weight:600; }
  .ai-body{ padding:10px; height:340px; overflow:auto; font-size:14px; }
  .ai-input{ display:flex; border-top:1px solid #eef6ff; }
  .ai-input input{ flex:1; padding:10px; border:none; outline:none; }
  .ai-input button{ background:var(--accent2); border:none; color:white; padding:10px 12px; cursor:pointer; }
  .msg-user{ text-align:right; color:#084; margin:6px 0; }
  .msg-bot{ text-align:left; color:#053; margin:6px 0; }
  .badge{ background:#e8f5ff; color:var(--accent); padding:6px 8px; border-radius:8px; font-weight:600; }
  @media(max-width:900px){ .cards{ grid-template-columns:1fr; } .ai-chat{ right:10px; bottom:10px; } }
</style>
</head>
<body>
<header>
  <h1 id="hdrTitle">⚡ Smart Energy Bill Calculator (Offline)</h1>
</header>

<div class="container">
  <div class="topbar">
    <label id="lblLang">Language</label>
    <select id="selLang">
      <option value="en">English</option>
      <option value="hi">हिन्दी</option>
      <option value="te">తెలుగు</option>
      <option value="ta">தமிழ்</option>
      <option value="kn">ಕನ್ನಡ</option>
      <option value="ml">മലയാളം</option>
      <option value="mr">मराठी</option>
      <option value="bn">বাংলা</option>
      <option value="gu">ગુજરાતી</option>
      <option value="pa">ਪੰਜਾਬੀ</option>
    </select>

    <label id="lblRegion">Region</label>
    <select id="selRegion">
      <option value="ap">Andhra Pradesh</option>
      <option value="tg">Telangana</option>
      <option value="tn">Tamil Nadu</option>
      <option value="mh">Maharashtra</option>
      <option value="ka">Karnataka</option>
      <option value="kl">Kerala</option>
      <option value="gj">Gujarat</option>
      <option value="dl">Delhi</option>
      <option value="wb">West Bengal</option>
      <option value="generic">Generic India</option>
    </select>

    <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
      <div class="badge" id="langBadge">EN</div>
      <button id="openAI" class="primary">Assistant</button>
    </div>
  </div>

  <div class="controls">
    <button id="btnAdd" class="primary">+ Add Appliance</button>
    <button id="btnCalculate" class="primary">Calculate</button>
    <button id="btnReset" class="danger">Reset</button>
  </div>

  <div id="devices" class="devices"></div>

  <div id="results" class="cards" style="display:none;">
    <div class="card">
      <h3 id="applianceTitle">Appliance-wise Energy & Cost</h3>
      <div id="applianceList"></div>
    </div>
    <div class="card">
      <h3 id="summaryTitle">Summary & Suggestions</h3>
      <div id="summaryBox"></div>
      <div id="suggestBox" style="margin-top:8px;"></div>
      <div id="tipsBox" class="tips"></div>
    </div>
  </div>

  <div class="awareness" style="margin-top:14px;">
    <img src="https://cdn-icons-png.flaticon.com/512/2913/2913465.png" alt="save"/>
    <div>
      <div id="awTitle" style="font-weight:700">Save Electricity — Save Earth</div>
      <div id="awText" class="small">Turn off unused devices and prefer energy-efficient appliances.</div>
    </div>
  </div>
</div>

<!-- AI Chat Assistant (offline rule-based) -->
<div class="ai-chat" id="aiChat" style="display:none;">
  <div class="ai-header">
    <div id="aiTitle">Energy Assistant</div>
    <div style="cursor:pointer;" id="aiClose">✖</div>
  </div>
  <div class="ai-body" id="aiBody">
    <div class="msg-bot" id="aiWelcome">Hello — ask me about tariff slabs, how to save energy, or your bill calculation.</div>
  </div>
  <div class="ai-input">
    <input id="aiInput" placeholder="Ask (e.g. 'What are Telangana slabs?')" />
    <button id="aiSend">Send</button>
  </div>
</div>

<script>
/* ============================
   TRANSLATIONS - UI STRINGS & TEMPLATES (many languages)
   Keep translations concise; extend as needed.
   ============================ */
const UI_TEXT = {
  en: {
    hdr: "⚡ Smart Energy Bill Calculator (Offline)",
    lang: "Language",
    region: "Region",
    add: "+ Add Appliance",
    calculate: "Calculate",
    reset: "Reset",
    applianceTitle: "Appliance-wise Energy & Cost",
    summaryTitle: "Summary & Suggestions",
    awTitle: "Save Electricity — Save Earth",
    awText: "Turn off unused devices and prefer energy-efficient appliances.",
    aiWelcome: "Hello — ask me about tariff slabs, how to save energy, or your bill calculation.",
    tipsHeader: "Tips & Awareness",
    suggestionHeader: "Recommendations to reduce consumption",
    savingEstimate: "Estimated savings if followed"
  },
  hi: {
    hdr: "⚡ स्मार्ट एनर्जी बिल कैलकुलेटर (ऑफ़लाइन)",
    lang: "भाषा",
    region: "क्षेत्र",
    add: "+ उपकरण जोड़ें",
    calculate: "गणना करें",
    reset: "रीसेट",
    applianceTitle: "उपकरण अनुसार ऊर्जा एवं लागत",
    summaryTitle: "सारांश और सुझाव",
    awTitle: "बिजली बचाएं — पृथ्वी बचाएं",
    awText: "अनावश्यक उपकरण बंद करें और ऊर्जा-कुशल उपकरण चुनें।",
    aiWelcome: "नमस्ते — मुझसे टैरिफ स्लैब, बिजली बचत या बिल के बारे में पूछें।",
    tipsHeader: "सुझाव और जागरूकता",
    suggestionHeader: "खपत कम करने के सुझाव",
    savingEstimate: "अगर अपनाएँ तो अनुमानित बचत"
  },
  te: {
    hdr: "⚡ స్మార్ట్ ఎనర్జీ బిల్ కాలిక్యులేటర్ (ఆఫ్లైన్)",
    lang: "భాష",
    region: "ప్రాంతం",
    add: "+ పరికరం జోడించు",
    calculate: "లెక్కించు",
    reset: "రిసెట్",
    applianceTitle: "పరికరం వారీ ఎనర్జీ & ఖర్చు",
    summaryTitle: "సారాంశం & సిఫార్సులు",
    awTitle: "విద్యుత్ సేవ్ చేయండి — భూమిని రక్షించండి",
    awText: "వాడని పరికరాలను ఆపండి మరియు ఎనర్జీ-దక్ష పరికరాలు వాడండి.",
    aiWelcome: "హలో — టారిఫ్ స్లాబులు, బిల్లు లేదా విద్యుత్ పొదుపు గురించి అడగండి.",
    tipsHeader: "సూక్తులు & అవగాహన",
    suggestionHeader: "వాడకం తగ్గించే సిఫార్సులు",
    savingEstimate: "అనుసరించగలిగితే అభివృద్ధి సాధ్యం"
  },
  ta: {
    hdr: "⚡ ஸ்மார்ட் மின்சார கட்டண கணக்கீட்டர் (ஆஃப்லைன்)",
    lang: "மொழி",
    region: "மாநிலம்",
    add: "+ சாதனம் சேர்க்கவும்",
    calculate: "கணக்கிடு",
    reset: "மீட்டமைக்கவும்",
    applianceTitle: "சாதன வாரியான மின்சாரம் & செலவு",
    summaryTitle: "சுருக்கம் & பரிந்துரைகள்",
    awTitle: "மின்சாரம் சேமி — பூமியை காப்பாற்று",
    awText: "பயன்பாடு இல்லாத சாதனங்களை அணைக்கும் பழக்கம் கொள்ளுங்கள்.",
    aiWelcome: "வணக்கம் — கட்டணங்கள், சலாக்கள் அல்லது மின் சேமிப்பு பற்றி கேளுங்கள்.",
    tipsHeader: "பயனுள்ள குறிப்பு",
    suggestionHeader: "சேமிக்க எடுத்துக்கொள்ளும் பரிந்துரைகள்",
    savingEstimate: "பின்பற்றினால் சேமிப்பு"
  },
  kn: {
    hdr: "⚡ ಸ್ಮಾರ್ಟ್ ಎನರಜಿ ಬಿಲ್ ಕ್ಯಾಲ್ಕ್ಯುಲೇಟರ್ (ಆಫ್‌ಲೈನ್)",
    lang: "ಭಾಷೆ",
    region: "ಪ್ರಾಂತ",
    add: "+ ಸಾಧನ ಸೇರಿಸಿ",
    calculate: "ಲೆಕ್ಕ ಹಾಕು",
    reset: "ರಿಸೆಟ್",
    applianceTitle: "ಉಪಕರಣಾನುಸಾರ ಶಕ್ತಿ ಮತ್ತು ವೆಚ್ಚ",
    summaryTitle: "ಸಾರಾಂಶ ಮತ್ತು ಸಲಹೆಗಳು",
    awTitle: "ವಿದ್ಯುತ್ ಉಳಿಸು — ಭೂಮಿಯನ್ನು ಉಳಿಸು",
    awText: "ಬೇಡಿದಂತೆ ಉಪಕರಣಗಳನ್ನು ಆಯ್ಕೆ ಮಾಡಿ ಮತ್ತು ಬಳಸಿಕೊಳ್ಳಿ.",
    aiWelcome: "ಹಲೋ — ಟಾರಿಫ್, ಬಿಲ್ ಅಥವಾ ವಿದ್ಯುತ್ ಉಳಿತಾಯ ನೋಡಿ ಕೇಳಿ.",
    tipsHeader: "ಸಲಹೆಗಳು",
    suggestionHeader: "ಕ್ಸ್ಟಮ್ ಶಿಫಾರಸುಗಳು",
    savingEstimate: "ಸೂಚನೆ ಅನುಸರಿಸಿದಲ್ಲಿ ಉಳಿವು"
  },
  ml: {
    hdr: "⚡ സ്മാർട്ട് انرژی ബിൽ കാൽക്കുലേറ്റർ (ഓഫ്ലൈൻ)",
    lang: "ഭാഷ",
    region: "പ്രദേശം",
    add: "+ ഉപകരണം ചേർക്കുക",
    calculate: "ഗണന",
    reset: "വീണ്ടും സജ്ജമാക്കുക",
    applianceTitle: "ഉപകരണാനുസരണം ഊർജ്ജം & ചെലവ്",
    summaryTitle: "സംക്ഷേപം & sujipprakasham",
    awTitle: "വൈദ്യുതി സംരക്ഷിക്കുക — ഭൂമിയെ രക്ഷിക്കുക",
    awText: "ഉപയോഗിക്കാത്ത ഉപകരണങ്ങൾ ഓഫ് ചെയ്യുക, ഊർജ്ജബുദ്ധിയുള്ള ഉപകരണങ്ങൾ എടുക്കുക.",
    aiWelcome: "ഹലോ — ടാരിഫ് സ്ലാബുകൾ, ബിൽ, സേവ് ചെയ്യൽ എന്നിവ ചോദിക്കൂ.",
    tipsHeader: "തീർഞ്ഞെടുക്കാനുള്ള ടിപ്പുകൾ",
    suggestionHeader: "സംരക്ഷണ പരിപ്രേഷ്യ",
    savingEstimate: "അനുമാനിച്ചിട്ടുള്ള ലാഭം"
  },
  mr: {
    hdr: "⚡ स्मार्ट एनर्जी बिल कॅल्क्युलेटर (ऑफलाइन)",
    lang: "भाषा",
    region: "प्रदेश",
    add: "+ उपकरण जोडा",
    calculate: "गणना करा",
    reset: "रिसेट",
    applianceTitle: "उपकरणानुसार ऊर्जा व खर्च",
    summaryTitle: "सारांश व शिफारसी",
    awTitle: "विज बचवा — पृथ्वी वाचवा",
    awText: "वापरात नसलेली उपकरणे बंद करा आणि ऊर्जा-कुशल उपकरणे वापरा.",
    aiWelcome: "नमस्कार — टॅरिफ स्लॅब्स, बिल किंवा कसे वाचवायचे हे विचारा.",
    tipsHeader: "टीप्स",
    suggestionHeader: "शिफारसी",
    savingEstimate: "अनुमानित बचत"
  },
  bn: {
    hdr: "⚡ স্মার্ট এনার্জি বিল ক্যালকুলেটর (অফলাইন)",
    lang: "ভাষা",
    region: "অঞ্চল",
    add: "+ ডিভাইস যোগ করুন",
    calculate: "হিসাব করুন",
    reset: "রিসেট",
    applianceTitle: "ডিভাইস অনুযায়ী শক্তি ও খরচ",
    summaryTitle: "সারাংশ ও সুপারিশ",
    awTitle: "বিদ্যুৎ বাঁচান — পৃথিবী বাঁচান",
    awText: "অপ্রয়োজনীয় ডিভাইস বন্ধ করুন এবং শক্তি-দক্ষ ডিভাইস ব্যবহার করুন।",
    aiWelcome: "হ্যালো — ট্যারিফ স্ল্যাব, বিল বা সেভিং নিয়ে প্রশ্ন করুন।",
    tipsHeader: "পরামর্শ",
    suggestionHeader: "সাশ্রয়ী সুপারিশ",
    savingEstimate: "প্রায়ই সংরক্ষণ"
  },
  gu: {
    hdr: "⚡ સ્માર્ટ એનર્જી બિલ કેલ્ક્યુલેટર (ઓફલાઇન)",
    lang: "ભાષા",
    region: "પ્રદેશ",
    add: "+ ઉપકરણ ઉમેરો",
    calculate: "ગણના કરો",
    reset: "રીસેટ",
    applianceTitle: "ઉપકરણ પ્રમાણે ઊર્જા અને ખર્ચ",
    summaryTitle: "સારાંશ અને ભલામણો",
    awTitle: "બિજળી બચાવો — ધરતી બચાવો",
    awText: "જે ઉપકરણો કામે નથી તે બંધ રાખો અને ઊર્જા-કાર્યક્ષમ ઉપકરણો પસંદ કરો.",
    aiWelcome: "હેલો — ટેરિફ, સ્લાબ કે બિલ વિશે પૂછો.",
    tipsHeader: "સૂટ",
    suggestionHeader: "સુઝાવ",
    savingEstimate: "અંદાજિત બચત"
  },
  pa: {
    hdr: "⚡ ਸਮਾਰਟ انرجي ਬਿੱਲ ਕੈਲਕੁਲੇਟਰ (ਆਫ਼ਲਾਈਨ)",
    lang: "ਭਾਸ਼ਾ",
    region: "ਇਲਾਕਾ",
    add: "+ ਡਿਵਾਈਸ ਜੋੜੋ",
    calculate: "ਹਿਸਾਬ ਕਰੋ",
    reset: "ਰੀਸੈਟ",
    applianceTitle: "ਡਿਵਾਈਸ-ਅਨੁਸਾਰ ਊਰਜਾ ਅਤੇ ਖਰਚ",
    summaryTitle: "ਸੰਖੇਪ ਅਤੇ ਸੁਝਾਅ",
    awTitle: "ਬਿਜਲੀ ਬਚਾਓ — ਧਰਤੀ ਬਚਾਓ",
    awText: "ਬੇਕਾਰ ਡਿਵਾਈਸ ਬੰਦ ਕਰੋ ਅਤੇ ਊਰਜਾ-ਕੁਸ਼ਲ ਉਪਕਰਣ ਵਰਤੋਂ.",
    aiWelcome: "ਹੈਲੋ — ਟੈਰੀਫ਼ ਸਲੈਬ, ਬਿੱਲ ਜਾਂ ਬਚਤ ਬਾਰੇ ਪੁੱਛੋ.",
    tipsHeader: "ਸੁਝਾਅ",
    suggestionHeader: "ਸਿਫਾਰਿਸ਼ਾਂ",
    savingEstimate: "ਅਨੁਮਾਨਤ ਬਚਤ"
  }
};

/* ============================
   REGION TARIFF DATA (sample)
   Replace with official values if needed
   Each region has 'slabs': array of { upto: number, rate: ₹/unit } progressive;
   and 'fixedPerKW' in ₹ per kW per month.
   ============================ */
const REGION_DATA = {
  ap: {
    name: "Andhra Pradesh",
    slabs: [
      { upto: 50, rate: 1.45 },
      { upto: 100, rate: 2.50 },
      { upto: 200, rate: 4.00 },
      { upto: 400, rate: 6.00 },
      { upto: Infinity, rate: 8.50 }
    ],
    fixedPerKW: 25
  },
  tg: {
    name: "Telangana",
    slabs: [
      { upto: 50, rate: 1.50 },
      { upto: 100, rate: 2.80 },
      { upto: 200, rate: 4.50 },
      { upto: 400, rate: 6.50 },
      { upto: Infinity, rate: 9.00 }
    ],
    fixedPerKW: 30
  },
  tn: {
    name: "Tamil Nadu",
    slabs: [
      { upto: 100, rate: 2.00 },
      { upto: 200, rate: 3.50 },
      { upto: 500, rate: 6.00 },
      { upto: Infinity, rate: 8.00 }
    ],
    fixedPerKW: 28
  },
  mh: {
    name: "Maharashtra",
    slabs: [
      { upto: 100, rate: 3.00 },
      { upto: 300, rate: 5.50 },
      { upto: 500, rate: 7.00 },
      { upto: Infinity, rate: 9.00 }
    ],
    fixedPerKW: 35
  },
  ka: {
    name: "Karnataka",
    slabs: [
      { upto: 50, rate: 1.80 },
      { upto: 200, rate: 4.00 },
      { upto: 400, rate: 6.20 },
      { upto: Infinity, rate: 8.00 }
    ],
    fixedPerKW: 30
  },
  kl: {
    name: "Kerala",
    slabs: [
      { upto: 40, rate: 1.50 },
      { upto: 100, rate: 4.25 },
      { upto: 150, rate: 5.50 },
      { upto: 250, rate: 7.20 },
      { upto: Infinity, rate: 9.20 }
    ],
    fixedPerKW: 40
  },
  gj: {
    name: "Gujarat",
    slabs: [
      { upto: 100, rate: 2.50 },
      { upto: 300, rate: 5.00 },
      { upto: Infinity, rate: 8.00 }
    ],
    fixedPerKW: 32
  },
  dl: {
    name: "Delhi",
    slabs: [
      { upto: 200, rate: 3.00 },
      { upto: 400, rate: 4.50 },
      { upto: 800, rate: 6.50 },
      { upto: Infinity, rate: 8.00 }
    ],
    fixedPerKW: 20
  },
  wb: {
    name: "West Bengal",
    slabs: [
      { upto: 100, rate: 2.50 },
      { upto: 300, rate: 5.00 },
      { upto: Infinity, rate: 8.50 }
    ],
    fixedPerKW: 30
  },
  generic: {
    name: "Generic India",
    slabs: [
      { upto: 300, rate: 5.00 },
      { upto: 600, rate: 7.50 },
      { upto: Infinity, rate: 10.00 }
    ],
    fixedPerKW: 40
  }
};

/* ============================
   APPLIANCE DATA (icons, default watts, rating)
   ============================ */
const APPLIANCES = {
  "Fan": { w:75, icon:"https://cdn-icons-png.flaticon.com/512/447/447951.png", rating:5 },
  "Tube Light": { w:40, icon:"https://cdn-icons-png.flaticon.com/512/2913/2913479.png", rating:3 },
  "LED Bulb": { w:10, icon:"https://cdn-icons-png.flaticon.com/512/2942/2942877.png", rating:5 },
  "Air Conditioner": { w:1200, icon:"https://cdn-icons-png.flaticon.com/512/1968/1968157.png", rating:3 },
  "Refrigerator": { w:150, icon:"https://cdn-icons-png.flaticon.com/512/2917/2917242.png", rating:5 },
  "Laptop": { w:60, icon:"https://cdn-icons-png.flaticon.com/512/3793/3793465.png", rating:5 },
  "TV": { w:120, icon:"https://cdn-icons-png.flaticon.com/512/2920/2920011.png", rating:3 },
  "Washing Machine": { w:500, icon:"https://cdn-icons-png.flaticon.com/512/2917/2917476.png", rating:3 },
  "Microwave": { w:1000, icon:"https://cdn-icons-png.flaticon.com/512/3075/3075977.png", rating:3 },
  "Iron": { w:800, icon:"https://cdn-icons-png.flaticon.com/512/2917/2917011.png", rating:3 },
  "Water Heater": { w:1500, icon:"https://cdn-icons-png.flaticon.com/512/2917/2917047.png", rating:3 }
};

/* ============================
   Helper: translate UI & templates
   ============================ */
const selLang = document.getElementById('selLang');
const selRegion = document.getElementById('selRegion');
const langBadge = document.getElementById('langBadge');

let CURRENT_LANG = 'en';

function applyTranslations(){
  const t = UI_TEXT[CURRENT_LANG] || UI_TEXT.en;
  document.getElementById('hdrTitle').innerText = t.hdr;
  document.getElementById('lblLang').innerText = t.lang;
  document.getElementById('lblRegion').innerText = t.region;
  document.getElementById('btnAdd').innerText = t.add;
  document.getElementById('btnCalculate').innerText = t.calculate;
  document.getElementById('btnReset').innerText = t.reset;
  document.getElementById('applianceTitle').innerText = t.applianceTitle;
  document.getElementById('summaryTitle').innerText = t.summaryTitle;
  document.getElementById('awTitle').innerText = t.awTitle;
  document.getElementById('awText').innerText = t.awText;
  document.getElementById('aiWelcome').innerText = t.aiWelcome;
  document.getElementById('tipsBox').innerText = '';
  langBadge.innerText = CURRENT_LANG.toUpperCase();
  // appliance dropdown labels themselves will be localized when building rows
}

/* ============================
   Build / manage device rows
   ============================ */
const devicesDiv = document.getElementById('devices');

function createDeviceRow(){
  const row = document.createElement('div');
  row.className = 'device-row';

  // build appliance select with localized names (we keep keys in English; translation optional)
  const selectHTML = `<select class="ap-select">
      <option value="">-- select appliance --</option>
      ${Object.keys(APPLIANCES).map(a=>`<option value="${a}">${a}</option>`).join('')}
    </select>`;
  row.innerHTML = `
    <img class="icon" src="https://cdn-icons-png.flaticon.com/512/565/565547.png" alt="icon" />
    ${selectHTML}
    <input class="ap-custom" placeholder="Or type appliance name" />
    <input class="ap-power" placeholder="Power (W)" />
    <input class="ap-hrs" placeholder="Hours/day" />
    <div style="min-width:70px" class="ap-rating small"></div>
    <button class="remove-btn">Remove</button>
  `;

  devicesDiv.appendChild(row);

  const img = row.querySelector('img.icon');
  const sel = row.querySelector('.ap-select');
  const custom = row.querySelector('.ap-custom');
  const power = row.querySelector('.ap-power');
  const hrs = row.querySelector('.ap-hrs');
  const ratingDiv = row.querySelector('.ap-rating');

  // select change:
  sel.addEventListener('change', ()=>{
    if(sel.value){
      custom.value = '';
      custom.disabled = true;
      const d = APPLIANCES[sel.value];
      power.value = d.w;
      img.src = d.icon;
      ratingDiv.innerHTML = `${d.rating}★`;
    } else {
      custom.disabled = false;
      power.value = '';
      ratingDiv.innerHTML = '';
      img.src = 'https://cdn-icons-png.flaticon.com/512/565/565547.png';
    }
  });

  // manual typing:
  custom.addEventListener('input', ()=>{
    const name = custom.value.trim();
    if(name){
      sel.disabled = true;
      const estimated = estimateWattsFromName(name);
      power.value = estimated;
      img.src = 'https://cdn-icons-png.flaticon.com/512/565/565547.png';
      ratingDiv.innerHTML = '';
    } else {
      sel.disabled = false;
      power.value = '';
      ratingDiv.innerHTML = '';
      img.src = 'https://cdn-icons-png.flaticon.com/512/565/565547.png';
    }
  });

  row.querySelector('.remove-btn').addEventListener('click', ()=> row.remove());
}

/* initial row */
createDeviceRow();

/* Add / Reset handlers */
document.getElementById('btnAdd').addEventListener('click', ()=> createDeviceRow());
document.getElementById('btnReset').addEventListener('click', ()=>{
  devicesDiv.innerHTML = '';
  createDeviceRow();
  document.getElementById('results').style.display = 'none';
});

/* ============================
   Watt estimation helper for manual names
   ============================ */
function estimateWattsFromName(name){
  const n = name.toLowerCase();
  if(n.includes('ac') || n.includes('air')) return 1200;
  if(n.includes('heater') || n.includes('geyser')) return 1500;
  if(n.includes('fan')) return 75;
  if(n.includes('bulb') || n.includes('light')) return 12;
  if(n.includes('tv')) return 120;
  if(n.includes('laptop') || n.includes('computer')) return 60;
  if(n.includes('fridge') || n.includes('refrigerator')) return 150;
  if(n.includes('microwave')) return 1000;
  if(n.includes('iron')) return 800;
  if(n.includes('wash') || n.includes('washing')) return 500;
  if(n.includes('pump')) return 500;
  return 150;
}

/* ============================
   Progressive billing function
   Input: units, regionKey, installedKW
   Returns: { energyCost, fixedCharge, totalCost, breakdownArray }
   breakdownArray: [{ used, rate, cost }]
   ============================ */
function computeBillProgressive(units, regionKey, installedKW=0){
  const region = REGION_DATA[regionKey] || REGION_DATA.generic;
  let remaining = units;
  let prevLimit = 0;
  let eCost = 0;
  const breakdown = [];
  for(const slab of region.slabs){
    const cap = isFinite(slab.upto) ? (slab.upto - prevLimit) : Infinity;
    const used = Math.max(0, Math.min(remaining, cap));
    if(used > 0){
      const c = used * slab.rate;
      breakdown.push({ used, rate: slab.rate, cost: c });
      eCost += c;
      remaining -= used;
    }
    prevLimit = slab.upto;
    if(remaining <= 0) break;
  }
  const fixed = (installedKW || 0) * region.fixedPerKW;
  return { energyCost: eCost, fixedCharge: fixed, totalCost: eCost + fixed, breakdown };
}

/* ============================
   Calculate button logic
   ============================ */
document.getElementById('btnCalculate').addEventListener('click', ()=> {
  const regionKey = selRegion.value || 'generic';
  const rows = Array.from(document.querySelectorAll('.device-row'));
  if(rows.length === 0){ alert(UI_TEXT[CURRENT_LANG].add); return; }

  // collect devices
  const devices = rows.map(r=>{
    const sel = r.querySelector('.ap-select');
    const custom = r.querySelector('.ap-custom');
    const pwr = parseFloat(r.querySelector('.ap-power').value) || 0;
    const hrs = parseFloat(r.querySelector('.ap-hrs').value) || 0;
    const name = sel.value || (custom.value.trim() || 'Unnamed Device');
    const icon = r.querySelector('img.icon').src;
    const rating = APPLIANCES[name] ? APPLIANCES[name].rating : null;
    return { name, power: pwr, hrs, icon, rating };
  });

  // compute per-device units and monthly totals
  let totalDailyUnits = 0;
  let totalMonthlyUnits = 0;
  let installedKW = 0;
  const parts = [];
  for(const d of devices){
    const daily = (d.power / 1000) * d.hrs;
    const weekly = daily * 7;
    const monthly = daily * 30;
    totalDailyUnits += daily;
    totalMonthlyUnits += monthly;
    installedKW += d.power / 1000;
    // show estimated cost for appliance alone (note: slabs apply on total; we still show per-appliance estimate using same slab logic for reference)
    const apBill = computeBillProgressive(monthly, regionKey, 0);
    parts.push({ d, daily, weekly, monthly, apCost: apBill.totalCost, apBreak: apBill.breakdown });
  }

  // overall billing with installedKW rounding up to nearest 0.1
  const installedKWRounded = Math.ceil(installedKW * 10) / 10;
  const overall = computeBillProgressive(totalMonthlyUnits, regionKey, installedKWRounded);

  // build appliance list HTML
  const applianceList = parts.map(p=>`
    <div class="appliance-row">
      <div style="display:flex; gap:10px; align-items:center;">
        <img src="${p.d.icon}" class="icon" style="width:36px;height:36px;border-radius:6px"/>
        <div>
          <div style="font-weight:700">${p.d.name} ${p.d.rating ? `<span style="color:#f59e0b">(${p.d.rating}★)</span>` : ''}</div>
          <div class="small">Power: ${p.d.power} W • ${p.d.hrs} hrs/day</div>
        </div>
      </div>
      <div style="text-align:right;">
        <div class="small">Daily: ${p.daily.toFixed(2)} u</div>
        <div class="small">Weekly: ${p.weekly.toFixed(2)} u</div>
        <div style="font-weight:700">Monthly: ${p.monthly.toFixed(2)} u</div>
        <div class="small">Est. Cost: ₹${p.apCost.toFixed(2)}</div>
      </div>
    </div>
  `).join('');

  document.getElementById('applianceList').innerHTML = applianceList;

  // suggestions if slabs crossed
  const region = REGION_DATA[regionKey] || REGION_DATA.generic;
  const slabCaps = region.slabs.map(s=>s.upto).filter(u=>isFinite(u));
  const crossed = slabCaps.filter(c=> totalMonthlyUnits > c);
  let suggHtml = '';
  if(crossed.length === 0){
    suggHtml = `<div class="small">${UI_TEXT[CURRENT_LANG].tipsHeader}: ${CURRENT_LANG === 'en' ? 'You are within the lowest slab.' : ''}</div>`;
  } else {
    // propose reductions to get under the nearest lower slab
    const nearestLower = crossed[0]; // the first slab limit crossed
    const target = nearestLower; // target monthly units
    let excessUnits = totalMonthlyUnits - target;
    // Sort devices by monthly consumption contribution descending
    const byContribution = parts.slice().sort((a,b)=> (b.monthly - a.monthly));
    const recs = [];
    for(const p of byContribution){
      if(excessUnits <= 0) break;
      const reducible = Math.min(p.monthly, excessUnits);
      const reduceHrs = reducible / ((p.d.power/1000) * 30 || 1);
      const newHrs = Math.max(0, p.d.hrs - reduceHrs);
      if(reduceHrs > 0.05){
        recs.push({ name: p.d.name, newHrs: newHrs.toFixed(1), savedUnits: reducible.toFixed(1) });
        excessUnits -= reducible;
      }
    }
    if(recs.length === 0){
      suggHtml = `<div class="small">${CURRENT_LANG==='en' ? 'Reduce heavy appliances (AC, Heater) usage to lower slabs.' : ''}</div>`;
    } else {
      suggHtml = `<div style="font-weight:700">${UI_TEXT[CURRENT_LANG].suggestionHeader}</div><ul>${recs.map(r=>`<li>${CURRENT_LANG==='en' ? `${r.name}: use ~${r.newHrs} hrs/day → save ${r.savedUnits} units/month` : r.name + ' → ' + r.newHrs + ' घं/दिन (बचत ' + r.savedUnits + ' यूनिट)'}`).join('')}</ul>`;
      // estimate money saved to reduce those savedUnits
      const savedUnits = recs.reduce((s,r)=> s + parseFloat(r.savedUnits), 0);
      const hypot = computeBillProgressive(totalMonthlyUnits - savedUnits, regionKey, installedKWRounded);
      const moneySaved = Math.max(0, overall.totalCost - hypot.totalCost);
      suggHtml += `<div style="margin-top:8px; font-weight:700">${UI_TEXT[CURRENT_LANG].savingEstimate}: ₹${moneySaved.toFixed(2)}</div>`;
    }
  }

  // tips localized sample
  const tipsArr = [
    CURRENT_LANG==='hi' ? "LED बल्ब का उपयोग करें।" : CURRENT_LANG==='te' ? "LED బల్బ్ ఉపయోగించండి." :
    CURRENT_LANG==='ta' ? "LED பள்ப் பயன்படுத்தவும்." : CURRENT_LANG==='kn' ? "LED ಬಲ್ಬ್ ಬಳಸಿ." :
    CURRENT_LANG==='ml' ? "LED ബൾബ് ഉപയോഗിക്കുക." : CURRENT_LANG==='mr' ? "LED बल्ब वापरा." :
    CURRENT_LANG==='bn' ? "LED বাতি ব্যাবহার করুন." : CURRENT_LANG==='gu' ? "LED બલ્બ વાપરો." :
    CURRENT_LANG==='pa' ? "LED ਬਲਬ ਵਰਤੋ." : "Use LED bulbs instead of incandescent."
    ,
    CURRENT_LANG==='hi' ? "अनावश्यक उपकरण बंद रखें।" : CURRENT_LANG==='te' ? "వాడని పరికరాలు ఆపండి." :
    CURRENT_LANG==='ta' ? "பயன்பாடு இல்லாத சாதனங்களை அணை." : CURRENT_LANG==='kn' ? "ಬಳಸದೆ ಇದ್ದ ಪరికರಗಳನ್ನು ನಿಲ್ಲಿಸಿ." :
    CURRENT_LANG==='ml' ? "വേണ്ടാത്ത ഉപകരണങ്ങൾ ഓഫാക്കുക." : CURRENT_LANG==='mr' ? "गरज नसलेली उपकरणे बंद ठेवा." :
    CURRENT_LANG==='bn' ? "অপ্রয়োজনীয় ডিভাইস বন্ধ করুন." : CURRENT_LANG==='gu' ? "અનાવશ્યક ઉપકરણો બંધ રાખો." :
    CURRENT_LANG==='pa' ? "ਬੇਕਾਰ ਡਿਵਾਈਸ ਬੰਦ ਕਰੋ." : "Turn off unused appliances."
    ,
    CURRENT_LANG==='hi' ? "AC फिल्टर मेंटेन रखें और 24–26°C रखें।" : CURRENT_LANG==='te' ? "AC ఫిల్టర్లు శుభ్రంగా ఉంచండి; 24–26°C లో ఉంచండి." :
    CURRENT_LANG==='ta' ? "AC फिल்டர்களை பராமரிக்கவும்; 24–26°C அமைக்கவும்." : CURRENT_LANG==='kn' ? "AC ಫಿಲ್ಟರ್ ತೊಳೆಯಿರಿ, 24–26°C ಇಟ್ಟುಕೊಳ್ಳಿ." :
    CURRENT_LANG==='ml' ? "AC ഫിൽട്ടറുകൾ പരിപാലിക്കുക; 24–26°C." : CURRENT_LANG==='mr' ? "AC फिल्टर ठेवा; 24–26°C सेट करा." :
    CURRENT_LANG==='bn' ? "AC ফিল্টার বজায় রাখুন; 24–26°C রাখুন." : CURRENT_LANG==='gu' ? "AC ફિલ્ટર જાળવો; 24–26°C રાખો." :
    CURRENT_LANG==='pa' ? "AC ਫਿਲਟਰ ਸਾਫ਼ ਰੱਖੋ; 24–26°C." : "Maintain AC filters and keep 24–26°C."
  ];

  // summary box
  const summaryHTML = `
    <div><strong>${CURRENT_LANG==='en' ? 'Total Daily Units' : 'दैनिक यूनिट'}:</strong> ${totalDailyUnits.toFixed(2)} u</div>
    <div><strong>${CURRENT_LANG==='en' ? 'Total Weekly Units' : 'साप्ताहिक यूनिट'}:</strong> ${(totalDailyUnits*7).toFixed(2)} u</div>
    <div><strong>${CURRENT_LANG==='en' ? 'Total Monthly Units' : 'मासिक यूनिट'}:</strong> ${totalMonthlyUnits.toFixed(2)} u</div>
    <hr/>
    <div><strong>${CURRENT_LANG==='en' ? 'Energy Charges' : 'ऊर्जा शुल्क'}:</strong> ₹${overall.energyCost.toFixed(2)}</div>
    <div><strong>${CURRENT_LANG==='en' ? 'Fixed Charges' : 'फिक्स्ड चार्ज'}:</strong> ₹${overall.fixedCharge.toFixed(2)} (${installedKWRounded.toFixed(1)} kW × ₹${(region.fixedPerKW).toFixed(2)}/kW)</div>
    <div style="font-size:18px; margin-top:6px; font-weight:800">${CURRENT_LANG==='en' ? 'Total Estimated Bill' : 'कुल अनुमानित बिल'}: ₹${overall.totalCost.toFixed(2)}</div>
    <hr/>
    <div style="font-size:13px;" class="small">${CURRENT_LANG==='en' ? 'Region:' : 'क्षेत्र:'} ${region.name}</div>
  `;

  document.getElementById('summaryBox').innerHTML = summaryHTML;
  document.getElementById('suggestBox').innerHTML = suggHtml;
  document.getElementById('tipsBox').innerHTML = `<h4>${UI_TEXT[CURRENT_LANG].tipsHeader}</h4><ul>${tipsArr.map(t=>`<li>${t}</li>`).join('')}</ul>`;

  document.getElementById('results').style.display = 'grid';
});

/* ============================
   AI Assistant (offline rule-based)
   - Answers in selected language
   - Understands queries about slabs, region tariffs, fixed charges, saving tips, star ratings and calculation summary
   ============================ */
const aiChat = document.getElementById('aiChat');
const aiBody = document.getElementById('aiBody');
const aiInput = document.getElementById('aiInput');
const aiSend = document.getElementById('aiSend');

document.getElementById('openAI').addEventListener('click', ()=> {
  aiChat.style.display = 'flex';
  // update welcome according to language
  aiBody.innerHTML = `<div class="msg-bot">${UI_TEXT[CURRENT_LANG].aiWelcome}</div>`;
});

document.getElementById('aiClose').addEventListener('click', ()=> aiChat.style.display = 'none');

function pushUserMsg(txt){
  const d = document.createElement('div'); d.className = 'msg-user'; d.innerHTML = `<strong>You:</strong> ${txt}`; aiBody.appendChild(d); aiBody.scrollTop = aiBody.scrollHeight;
}
function pushBotMsg(txt){
  const d = document.createElement('div'); d.className = 'msg-bot'; d.innerHTML = `<strong>Assistant:</strong> ${txt}`; aiBody.appendChild(d); aiBody.scrollTop = aiBody.scrollHeight;
}

/* language aware AI response generator (offline) */
function aiRespond(question){
  const q = question.toLowerCase();
  const lang = CURRENT_LANG;
  const regionKey = selRegion.value || 'generic';
  const region = REGION_DATA[regionKey] || REGION_DATA.generic;

  // helper to translate templated English answers to other languages (simple mapping)
  // We'll produce replies already translated for common intents
  // INTENTS: slabs, fixed charge, reduce, ratings, bill summary, how slabs work, appliance rating advice
  // region slabs
  if(q.includes('slab') || q.includes('slabs') || q.includes('स्लैब') || q.includes('सħed')){
    // produce slab info lines
    const lines = region.slabs.map(s => {
      const uptoText = isFinite(s.upto) ? `≤ ${s.upto} units` : `> ${region.slabs[region.slabs.length-2]?.upto || 0} units`;
      return `${uptoText}: ₹${s.rate.toFixed(2)}/unit`;
    });
    if(lang==='en') return `Region ${region.name} slabs — ${lines.join(' • ')}`;
    if(lang==='hi') return `${region.name} के स्लैब — ${lines.join(' • ')}`;
    if(lang==='te') return `${region.name} స్లాబ్లు — ${lines.join(' • ')}`;
    if(lang==='ta') return `${region.name} சலாக்கள் — ${lines.join(' • ')}`;
    if(lang==='kn') return `${region.name} ಸ್ಲಾಬ್‌ಗಳು — ${lines.join(' • ')}`;
    if(lang==='ml') return `${region.name} സ്ലാബുകൾ — ${lines.join(' • ')}`;
    if(lang==='mr') return `${region.name} स्लीब्स — ${lines.join(' • ')}`;
    if(lang==='bn') return `${region.name} স্ল্যাব — ${lines.join(' • ')}`;
    if(lang==='gu') return `${region.name} સ્લેબ્સ — ${lines.join(' • ')}`;
    if(lang==='pa') return `${region.name} ਸਲੈਬ — ${lines.join(' • ')}`;
  }

  if(q.includes('fixed') || q.includes('fixed charge') || q.includes('फिक्स्ड')){
    const fc = region.fixedPerKW;
    if(lang==='en') return `Fixed charge in ${region.name}: ₹${fc}/kW per month (applied to installed load).`;
    if(lang==='hi') return `${region.name} में फिक्स्ड चार्ज: ₹${fc}/kW प्रति माह (इंस्टॉल्ड लोड पर)।`;
    if(lang==='te') return `${region.name}లో ఫిక్స్డ్ చార్జ్: ₹${fc}/kW ప్రతి నెల (ఇన్స్టాల్డ్ లోడ్ కు)`;
    if(lang==='ta') return `${region.name} இல் நிலையான கட்டணம்: ₹${fc}/kW மாதத்திற்கு.`;
    if(lang==='kn') return `${region.name} ಫಿಕ್ಸ್ಡ್ ಚಾರ್ಜ್: ₹${fc}/kW ಪ್ರತಿ ತಿಂಗಳು.`;
    if(lang==='ml') return `${region.name} ഫിക്സഡ് ചാർജ്: ₹${fc}/kW പ്രതി മാസം.`;
    if(lang==='mr') return `${region.name} मध्ये फिक्स्ड चार्ज: ₹${fc}/kW प्रति महिना.`;
    if(lang==='bn') return `${region.name} এ ফিক্সড চার্জ: ₹${fc}/kW প্রতি মাস।`;
    if(lang==='gu') return `${region.name} માં ફિક્સ્ડ ચાર્જ: ₹${fc}/kW પ્રતિ માસ.`;
    if(lang==='pa') return `${region.name} ਵਿੱਚ ਫਿਕਸਡ ਚਾਰਜ: ₹${fc}/kW ਪ੍ਰਤੀ ਮਹੀਨਾ.`;
  }

  if(q.includes('reduce') || q.includes('reduce') || q.includes('save') || q.includes('बच') || q.includes('తగ్గ')){
    if(lang==='en') return "Ways to reduce: use LED bulbs, switch off idle devices, maintain AC filters, run large appliances during off-peak, and replace old 3★ appliances with 5★ ones if used often.";
    if(lang==='hi') return "बचाने के तरीके: LED बल्ब, बेकार उपकरण बंद करें, AC फिल्टर साफ रखें, भारी उपकरण ऑफ-पीक में चलाएँ, और पुराने 3★ उपकरणों को 5★ से बदलें।";
    if(lang==='te') return "తగ్గించే మార్గాలు: LED బల్బ్ వాడండి, ఉపయోగంలో లేని పరికరాలు ఆపండి, AC ఫిల్టర్‌లను పరిశీలించండి, పెద్ద పరికరాలను ఆఫ్-పీక్‌లో నడపండి.";
    if(lang==='ta') return "குறைப்பதற்கான வழிகள்: LED விளக்குகளைப் பயன்படு, பயன்படுத்தாத சாதனங்களை அணை, AC வடிகட்டிகளை பராமரிக்கவும்.";
    if(lang==='kn') return "ಉಳಿಸುವ ವಿಧಾನಗಳು: LED ಬಳಸಿ, ಅನವಶ್ಯಕ ಸಾಧನಗಳನ್ನು ಮැಡುಮಾಡಿ, AC ಫಿಲ್ಟರ್ ಅನ್ನು ತೊಂದರೆಗೆ ತರುವಂತೆ ಇರಿಸಬೇಡಿ.";
    if(lang==='ml') return "ചുരുക്കാനുള്ള മാർഗങ്ങൾ: LED ബൾബ് ഉപയോഗിക്കുക, ഉപയോക്താക്കാഴ്ചകൾ ഓഫ് ചെയ്യുക, AC ഫിൽട്ടർ പരിപാലിക്കുക.";
    if(lang==='mr') return "कमी करण्याचे मार्ग: LED बल्ब वापरा, अनावश्यक उपकरण बंद करा, AC फिल्टर सांभाळा.";
    if(lang==='bn') return "কমানোর উপায়: LED ব্যবহার করুন, অপ্রয়োজনীয় ডিভাইস বন্ধ করুন, AC ফিল্টার রক্ষণাবেক্ষণ করুন।";
    if(lang==='gu') return "કમાવવાની રીતો: LED બલ્બ વાપરો, અગત્યના ઉપકરણો બંધ રાખો, AC ફિલ્ટર જાળવો.";
    if(lang==='pa') return "ਘਟਾਉਣ ਦੇ ਤਰੀਕੇ: LED ਨੁਓਂ ਵਰਤੋਂ, ਬੇਕਾਰ ਡਿਵਾਈਸ ਬੰਦ ਕਰੋ, AC ਫਿਲਟਰ ਰੱਖੋ.";
  }

  if(q.includes('5 star') || q.includes('5★') || q.includes('5 स्टार') || q.includes('5 स्टार')){
    if(lang==='en') return "5★ appliances are more energy-efficient; switching to 5★ can significantly reduce energy consumption.";
    if(lang==='hi') return "5★ उपकरण अधिक ऊर्जा-कुशल होते हैं।";
    if(lang==='te') return "5★ పరికరాలు ఎక్కువ శక్తి-సమర్థవంతం.";
    if(lang==='ta') return "5★ சாதனங்கள் அதிக மின்சார செயல்திறன்.";
    if(lang==='kn') return "5★ ಉಪಕರಣಗಳು ಹೆಚ್ಚು ಶಕ್ತಿದಾಯಕ.";
    if(lang==='ml') return "5★ ഉപകരണങ്ങൾ കൂടുതൽ ഊർജ്ജക്ഷമമാണ്.";
    if(lang==='mr') return "5★ उपकरणे जास्त ऊर्जा-कार्यक्षम असतात.";
    if(lang==='bn') return "5★ যন্ত্রপাতি বেশি শক্তি-দক্ষ।";
    if(lang==='gu') return "5★ ઉપકરણો વધુ ઊર્જા કાર્યક્ષમ છે.";
    if(lang==='pa') return "5★ ਯੰਤਰ ਜਿਆਦਾ ਊਰਜਾ-ਕੁਸ਼ਲ ਹਨ.";
  }

  // if user asks about the last calculation summary:
  if(q.includes('summary') || q.includes('bill') || q.includes('calculation') || q.includes('कुल') || q.includes('बिल') || q.includes('बिल कैसे')){
    // try to read summary DOM
    const resultsVisible = document.getElementById('results').style.display !== 'none';
    if(!resultsVisible){
      if(lang==='en') return "Please calculate first by adding appliances and clicking Calculate — then I can explain your bill.";
      if(lang==='hi') return "कृपया पहले गणना करें — फिर मैं आपका बिल समझा सकता हूँ।";
      if(lang==='te') return "దయచేసి ముందు లెక్కించండి — అప్పుడు నేను మీ బిల్ వివరించగలను.";
      if(lang==='ta') return "முதலில் கணக்கிடவும் — பின்னர் நான் உங்கள் பில்லைப் விளக்க முடியும்.";
      if(lang==='kn') return "ದಯವಿಟ್ಟು ಮೊದಲು ಲೆಕ್ಕಾಚಾರ ಮಾಡಿ — ನಂತರ ನಾನು ನಿಮಗೆ ವಿವರಿಸಬಹುದು.";
      if(lang==='ml') return "ദയവായി ആദ്യം ഗണിക്കൂ — പിന്നീട് ഞാൻ ബിൽ വിശദീകരിക്കാം.";
      if(lang==='mr') return "कृपया आधी गणना करा — मग मी बिल समजावून देईन.";
      if(lang==='bn') return "দয়া করে আগে হিসাব করুন — তারপর আমি আপনার বিল বুঝিয়ে দিতে পারব।";
      if(lang==='gu') return "કૃપા કરીને પહેલા ગણતરી કરો — પછી હું તમને બિલ સમજાવીશ.";
      if(lang==='pa') return "ਕਿਰਪਾ ਕਰਕੇ ਪਹਿਲਾਂ ਗਣਨਾ ਕਰੋ — ਫਿਰ ਮੈਂ ਤੁਹਾਨੂੰ ਬਿੱਲ ਸਮਝਾ ਸਕਦਾ ਹਾਂ।";
    } else {
      // collect summary text
      const sumText = document.getElementById('summaryBox').innerText || '';
      if(lang==='en') return `Current calculation summary:\n${sumText}`;
      if(lang==='hi') return `वर्तमान गणना सारांश:\n${sumText}`;
      if(lang==='te') return `ప్రస్తుత లెక్కింపు సారాంశం:\n${sumText}`;
      if(lang==='ta') return `தற்போதைய கணக்கீட்டு சுருக்கம்:\n${sumText}`;
      if(lang==='kn') return `ಪ್ರಸ್ತುತ ಲೆಕ್ಕಾಚಾರದ ಸಾರಾಂಶ:\n${sumText}`;
      if(lang==='ml') return `നിലവിലെ കണക്കിന്റെ സംക്ഷേപം:\n${sumText}`;
      if(lang==='mr') return `सध्याचे गणना सारांश:\n${sumText}`;
      if(lang==='bn') return `বতর্মান হিসাব সারসংক্ষেপ:\n${sumText}`;
      if(lang==='gu') return `વર્તમાન ગણતરી સારાંશ:\n${sumText}`;
      if(lang==='pa') return `ਮੌਜੂਦਾ ਗਣਨਾ ਸਾਰ:\n${sumText}`;
    }
  }

  // basic fallback help in chosen language
  if(lang==='en') return "I can explain slabs, fixed charges, savings tips, and your last calculation. Try: 'What are Telangana slabs?', 'How to reduce AC usage?', 'Explain my bill'.";
  if(lang==='hi') return "मैं स्लैब, फिक्स्ड चार्ज, बचत सुझाव और आपकी गणना समझा सकता हूँ। पूछें: 'तेलंगाना के स्लैब क्या हैं?', 'AC उपयोग कैसे घटाएँ?'.";
  if(lang==='te') return "నేను స్లాబ్‌లు, ఫిక్స్డ్ చార్జ్‌లు, సేవింగ్ సూచనలు మరియు మీ లెక్కింపును వివరించగలను. అడగండి: 'తెలంగాణ స్లాబ్లు ఏవి?'.";
  if(lang==='ta') return "நான் சலாக்கள், நிலையான கட்டணங்கள், சேமிப்பு யூகங்கள் மற்றும் உங்கள் கணக்கீட்டை விளக்க முடியும்.";
  if(lang==='kn') return "ನಾನು ಸ್ಲಾಬ್‌ಗಳು, ಫಿಕ್ಸ್ಡ್ ಶುಲ್ಕ, ಉಳಿಸುವ ಸಲಹೆ ಮತ್ತು ನಿಮ್ಮ ಲೆಕ್ಕಾಚಾರವನ್ನು ವಿವರಿಸಬಹುದು.";
  if(lang==='ml') return "ഞാൻ സ്ലാബുകൾ, ഫിക്സഡ് ചാർജുകൾ, ലാഭ നിർദ്ദേശങ്ങൾ എന്നിവ വിശദീകരിക്കാം.";
  if(lang==='mr') return "मी सॅलॅब, फिक्स्ड चार्ज, बचत सूचना आणि तुमचे गणन स्पष्ट करू शकतो.";
  if(lang==='bn') return "আমি স্ল্যাব, ফিক্সড চার্জ, সাশ্রয় পরামর্শ ব্যাখ্যা করতে পারি।";
  if(lang==='gu') return "હું સ્લેબ્સ, ફિક્સ્ડ ચાર્જ અને બચત સુચનો સમજાવી શકું છું.";
  if(lang==='pa') return "ਮੈਂ ਸਲੈਬ, ਫਿਕਸਡ ਚਾਰਜ, ਬਚਤ ਸੁਝਾਅ ਸਮਝਾ ਸਕਦਾ ਹਾਂ।";
}

/* AI send handler */
aiSend.addEventListener('click', ()=>{
  const q = aiInput.value.trim();
  if(!q) return;
  pushUserMsg(q);
  aiInput.value = '';
  const r = aiRespond(q);
  pushBotMsg(r);
});

/* enter key sends */
aiInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ aiSend.click(); e.preventDefault(); }
});

/* ============================
   Language change handling
   ============================ */
selLang.addEventListener('change', ()=>{
  CURRENT_LANG = selLang.value || 'en';
  applyTranslations();
  // update AI welcome message in chosen language
  document.getElementById('aiWelcome').innerText = UI_TEXT[CURRENT_LANG].aiWelcome;
  // update lang badge
  langBadge.innerText = CURRENT_LANG.toUpperCase();
});

/* initialize */
applyTranslations();
document.getElementById('aiWelcome').innerText = UI_TEXT[CURRENT_LANG].aiWelcome;

</script>
</body>
</html>
